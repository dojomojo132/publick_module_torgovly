#Область ОписаниеПеременных
&НаКлиенте
Перем ОжиданиеСозданияНоменклатуры;
#КонецОбласти

#Область ОбработчикиСобытийФормы

&НаКлиенте
Процедура ОбработкаОповещения(ИмяСобытия, Параметр, Источник)
	
	Если ИмяСобытия = "СозданаНоменклатура" И ОжиданиеСозданияНоменклатуры = Истина Тогда
		
		ОжиданиеСозданияНоменклатуры = Ложь;
		
		// Вызываем серверную функцию и получаем ID новой строки
		ИдентификаторСтроки = ДобавитьСтрокуСНовойНоменклатуройНаСервере(Параметр);
		
		// Устанавливаем курсор на новую строку
		Элементы.ДанныеНоменклатуры.ТекущаяСтрока = ИдентификаторСтроки;
		
		// Активируем поле "Цена" (имя элемента формы берем из свойств)
		Элементы.ДанныеНоменклатуры.ТекущийЭлемент = Элементы.ДанныеНоменклатурыЦена;
		
		// Переводим строку в режим редактирования, чтобы можно было сразу писать цену
		Элементы.ДанныеНоменклатуры.ИзменитьСтроку();
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовШапкиФормы
// Код процедур и функций
#КонецОбласти

#Область ОбработчикиСобытийЭлементовТаблицыФормыДанныеНоменклатуры

&НаКлиенте
Процедура ДанныеНоменклатурыШтрихКодПриИзменении(Элемент)
	
	ЗаполненыйШтрихКод = Элементы.ДанныеНоменклатуры.ТекущиеДанные.ШтрихКод;    
	НомерСтроки = Элементы.ДанныеНоменклатуры.ТекущаяСтрока;
	ШтрихКод = Формат(ЗаполненыйШтрихКод, "ЧРГ=' '; ЧГ=0"); // Обратите внимание: в ЧРГ стоит неразрывный пробел, как в оригинале
	
	Если ШтрихКод = 0 Тогда
		Возврат;
	КонецЕсли;
	
	Номенклатура = ПоискПоШтрихкодуНаСервере(ШтрихКод);
	
	Если Номенклатура = Неопределено Тогда 
		
		// Подготавливаем контекст (данные), которые понадобятся нам в следующих процедурах
		Контекст = Новый Структура;
		Контекст.Insert("ШтрихКод", ШтрихКод);
		Контекст.Insert("НомерСтроки", НомерСтроки);
		
		// Создаем описание оповещения для ответа на вопрос
		Оповещение = Новый ОписаниеОповещения("ВопросСозданияТовараЗавершение", ЭтотОбъект, Контекст);
		
		// Используем асинхронный вопрос вместо модального
		ПоказатьВопрос(Оповещение, "Товар не был обнаружен, перейти к созданию нового товара?", РежимДиалогаВопрос.ДаНет);
		
		Возврат;
		
	КонецЕсли;	
	
	ЗаполнитьДанныеНоменклатуры(Номенклатура, НомерСтроки);

КонецПроцедуры

&НаКлиенте
Процедура ВопросСозданияТовараЗавершение(Результат, Контекст) Экспорт
	
	Если Результат = КодВозвратаДиалога.Да Тогда
		
		ПараметрыФормы = Новый Структура("Штрихкод", Контекст.ШтрихКод);
		
		// Создаем описание оповещения, которое сработает ПОСЛЕ закрытия формы номенклатуры
		ОповещениеОЗакрытии = Новый ОписаниеОповещения("СозданиеТовараЗавершение", ЭтотОбъект, Контекст);
		
		// Открываем форму с передачей обработчика закрытия
		ОткрытьФорму("Справочник.Номенклатура.Форма.ФормаЭлемента", ПараметрыФормы, ЭтотОбъект, , , , ОповещениеОЗакрытии);
		
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура СозданиеТовараЗавершение(РезультатЗакрытия, Контекст) Экспорт
	
	// После закрытия формы снова ищем товар по штрихкоду.
	// Если пользователь сохранил товар, поиск вернет ссылку.
	Номенклатура = ПоискПоШтрихкодуНаСервере(Контекст.ШтрихКод);
	
	Если ЗначениеЗаполнено(Номенклатура) Тогда
		// Заполняем строку, используя сохраненный номер строки из контекста
		ЗаполнитьДанныеНоменклатуры(Номенклатура, Контекст.НомерСтроки);
	Иначе
		// Можно вывести сообщение, если товар так и не был создан или найден
		// Сообщение = Новый СообщениеПользователю;
		// Сообщение.Текст = "Товар не был создан.";
		// Сообщение.Сообщить();
	КонецЕсли;

КонецПроцедуры

&НаСервере
Процедура ЗаполнитьДанныеНоменклатуры(Номенклатура, НомерСтроки)
	
	НайденнаяСтрока = Объект.ДанныеНоменклатуры.НайтиПоИдентификатору(НомерСтроки);
	Если НайденнаяСтрока = Неопределено Тогда
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Строка не была обнаружена!";
		Сообщение.Поле = "ДанныеНоменклатуры[" + Формат(НомерСтроки, "ЧГ=0") + "]";
		Сообщение.Сообщить();
	Иначе
		НайденнаяСтрока.Номенклатура = Номенклатура;
		Если ЗначениеЗаполнено(Номенклатура) Тогда
			НайденнаяСтрока.Цена = Справочники.Номенклатура.ПолучитьЦенуТовара(Номенклатура);
			НайденнаяСтрока.Остаток = РегистрыНакопления.ОстаткиТоваров.ОстатокТовара(Номенклатура, Объект.Склад);
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ОбработкаСуммы(Элемент)
	Цена = Элементы.ДанныеНоменклатуры.ТекущиеДанные.Цена;
  	Остаток = Элементы.ДанныеНоменклатуры.ТекущиеДанные.Остаток;
	Элементы.ДанныеНоменклатуры.ТекущиеДанные.Сумма = Цена * Остаток;
КонецПроцедуры
#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура ОбработатьДанныеЦен(Команда)
	Ответ = Вопрос("Создать документ переоценки?", РежимДиалогаВопрос.ДаНет);
	Если Ответ = КодВозвратаДиалога.Да Тогда 
		ОбработатьДанныеЦенНаСервере();     
	КонецЕсли;
КонецПроцедуры

&НаСервере
Процедура ОбработатьДанныеЦенНаСервере()
	
	ТЗ_Переоценка = Новый ТаблицаЗначений;
	ТЗ_Переоценка.Колонки.Добавить("Номенклатура");
	ТЗ_Переоценка.Колонки.Добавить("Цена");
	
	Для Каждого Данные Из Объект.ДанныеНоменклатуры Цикл
		Если НЕ ЗначениеЗаполнено(Данные.Номенклатура) ИЛИ Данные.Цена=0 Тогда	
			Сообщить("В строка " + Данные.НомерСтроки + " заполнены не все данные!");
			Продолжить;
		КонецЕсли;   
		
		НоваяСтрока = ТЗ_Переоценка.Добавить();
		НоваяСтрока.Номенклатура = Данные.Номенклатура;
		НоваяСтрока.Цена = Данные.Цена;
		
	КонецЦикла;   
	
	Документы.Переоценка.СоздатьДокументПереоценки(ТЗ_Переоценка, ТекущаяДата());
	
КонецПроцедуры

&НаКлиенте
Процедура ПроверитьЗаполнениеДанных(Команда)
	ПроверитьЗаполнениеНаСервере();
КонецПроцедуры

&НаСервере
Процедура ПроверитьЗаполнениеНаСервере(Отказ = Ложь)
  
  Если Не ЗначениеЗаполнено(Объект.Склад) Тогда
    Сообщение = Новый СообщениеПользователю;
    Сообщение.Текст = "Заполните склад!";
    Сообщение.Поле = "Объект.Склад";
    Сообщение.УстановитьДанные(Объект);
    Сообщение.Сообщить();
    Отказ = Истина;
  КонецЕсли;
  
  // Проверяем незаполненные строки
  Для ИндексСтроки = 0 По Объект.ДанныеНоменклатуры.Количество() - 1 Цикл
    СтрокаТаблицы = Объект.ДанныеНоменклатуры[ИндексСтроки];
    НомерСтрокиСообщения = ИндексСтроки + 1;
    
    Если Не ЗначениеЗаполнено(СтрокаТаблицы.Номенклатура) Тогда
      Сообщение = Новый СообщениеПользователю;
      Сообщение.Текст = "В строке " + НомерСтрокиСообщения + " не заполнена номенклатура!";
      Сообщение.Поле = "Объект.ДанныеНоменклатуры[" + ИндексСтроки + "].Номенклатура";
      Сообщение.УстановитьДанные(Объект);
      Сообщение.Сообщить();
      Отказ = Истина;
    КонецЕсли;
    
    Если Не ЗначениеЗаполнено(СтрокаТаблицы.Цена) Тогда
      Сообщение = Новый СообщениеПользователю;
      Сообщение.Текст = "В строке " + НомерСтрокиСообщения + " не заполнена цена!";
      Сообщение.Поле = "Объект.ДанныеНоменклатуры[" + ИндексСтроки + "].Цена";
      Сообщение.УстановитьДанные(Объект);
      Сообщение.Сообщить();
      Отказ = Истина;
    КонецЕсли;
    
  КонецЦикла;
  
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Функция ПоискПоШтрихкодуНаСервере(Штрихкод) 
	
	Возврат Справочники.Номенклатура.ГлобальныйПоискПоШтрихКоду(Штрихкод);
	
КонецФункции // ПоискПоШтрихкодуНаСервере()

&НаКлиенте
Процедура ОбработатьОстатки(Команда)
	ОбработатьОстаткиНаСервере();
КонецПроцедуры

&НаСервере
Процедура ОбработатьОстаткиНаСервере()
	
	Если НЕ ЗначениеЗаполнено(Объект.Склад) Тогда
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Заполните склад!";
		Сообщение.Поле = "Объект.Склад";   
		Сообщение.УстановитьДанные(Объект.Склад);
		Сообщение.Сообщить();
		Возврат;                       
	КонецЕсли;
	
	ТЗ_Остаток = Новый ТаблицаЗначений;
	ТЗ_Остаток.Колонки.Добавить("Номенклатура");
	ТЗ_Остаток.Колонки.Добавить("Остаток");
	
	Для Каждого Данные Из Объект.ДанныеНоменклатуры Цикл
		Если НЕ ЗначениеЗаполнено(Данные.Номенклатура) ИЛИ Данные.Остаток=0 Тогда	
			Сообщить("В строка " + Данные.НомерСтроки + " заполнены не все данные!");
			Продолжить;
		КонецЕсли;   
		
		НоваяСтрока = ТЗ_Остаток.Добавить();
		НоваяСтрока.Номенклатура = Данные.Номенклатура;
		НоваяСтрока.Остаток = Данные.Остаток;
		
	КонецЦикла;   
	
	Документы.ВводОстатокТовараНаСкладе.СоздатьДокументВводОстатков(ТЗ_Остаток, Объект.Склад, ТекущаяДата());
КонецПроцедуры

&НаСервере
Процедура ДанныеНоменклатурыПриИзмененииНаСервере()
	Записать();
КонецПроцедуры

&НаКлиенте
Процедура ДанныеНоменклатурыПриИзменении(Элемент)
	ДанныеНоменклатурыПриИзмененииНаСервере();
КонецПроцедуры

&НаКлиенте
Процедура ДобавитьНоменклатуру(Команда)
	
	ОжиданиеСозданияНоменклатуры = Истина;
	
	// Добавляем обработчик закрытия на случай, если пользователь передумает и закроет крестиком
	Оповещение = Новый ОписаниеОповещения("ДобавитьНоменклатуруЗакрытие", ЭтотОбъект);
	
	// Открываем форму
	ОткрытьФорму("Справочник.Номенклатура.Форма.ФормаЭлемента", , ЭтотОбъект, , , , Оповещение);
	
КонецПроцедуры

&НаКлиенте
Процедура ДобавитьНоменклатуруЗакрытие(Результат, ДополнительныеПараметры) Экспорт
	// Если окно закрылось (любым способом), сбрасываем флаг.
	// Если запись произошла успешно, флаг уже был сброшен в ОбработкаОповещения.
	ОжиданиеСозданияНоменклатуры = Ложь;
КонецПроцедуры

&НаСервере
Функция ДобавитьСтрокуСНовойНоменклатуройНаСервере(НоменклатураСсылка)
	
	НоваяСтрока = Объект.ДанныеНоменклатуры.Добавить();
	
	КодТовара = НоменклатураСсылка.Код; 
	Попытка
		НоваяСтрока.ШтрихКод = Число(КодТовара);
	Исключение
		НоваяСтрока.ШтрихКод = 0;
	КонецПопытки;
	
	// Получаем идентификатор для поиска строки и последующего возврата
	ИдСтроки = НоваяСтрока.ПолучитьИдентификатор();
	
	ЗаполнитьДанныеНоменклатуры(НоменклатураСсылка, ИдСтроки);
	
	НоваяСтрока.Сумма = НоваяСтрока.Цена * НоваяСтрока.Остаток;
	
	// Возвращаем идентификатор на клиент
	Возврат ИдСтроки;
	
КонецФункции

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	Если НЕ ЗначениеЗаполнено(Объект.Склад) Тогда
		Объект.Склад = Справочники.Склады.Основной_ОПТ;
	КонецЕсли;
КонецПроцедуры

#КонецОбласти






